apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nofire-edge.configName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "nofire-edge.labels" . | nindent 4 }}
data:
  config.json: |
    {
      "logLevel": {{ .Values.config.logLevel | quote }},
      "serverPort": {{ .Values.config.serverPort }},
      "maxWorkers": {{ .Values.config.maxWorkers }},
      "processInterval": {{ .Values.config.processInterval | quote }},
      "graph": {
        "pruneInterval": {{ .Values.config.graph.pruneInterval | quote }},
        "maxPruneAge": {{ .Values.config.graph.maxPruneAge | quote }}
      },
      "kube": {
        "configPath": {{ .Values.config.kube.configPath | quote }},
        "resyncInterval": {{ .Values.config.kube.resyncInterval | quote }},
        "clusterName": {{ .Values.config.kube.clusterName | quote }},
        "resources": [
          {{- range $index, $resource := .Values.config.kube.resources }}
          {{- if $index }},{{ end }}
          {{ $resource | quote }}
          {{- end }}
        ]
      },
      "enableCausalAnalysis": {{ .Values.config.enableCausalAnalysis }},
      "causal": {
        "algorithm": {{ .Values.config.causal.algorithm | quote }},
        "interval": {{ .Values.config.causal.interval | quote }}
      },
      "services": {
        "workers": {{ .Values.config.services.workers }},
        {{- if .Values.config.services.address }}
        "address": {{ .Values.config.services.address | quote }},
        "maxConns": {{ .Values.config.services.maxConns }},
        "readTimeout": {{ .Values.config.services.readTimeout | quote }},
        "writeTimeout": {{ .Values.config.services.writeTimeout | quote }},
        "tls": {
          "enabled": {{ .Values.config.services.tls.enabled }},
          "certFile": {{ .Values.config.services.tls.certFile | quote }},
          "keyFile": {{ .Values.config.services.tls.keyFile | quote }},
          "caFile": {{ .Values.config.services.tls.caFile | quote }},
          "requireClientCert": {{ .Values.config.services.tls.requireClientCert }},
          "minVersion": {{ .Values.config.services.tls.minVersion | quote }},
          "cipherSuites": [
            {{- range $index, $suite := .Values.config.services.tls.cipherSuites }}
            {{- if $index }},{{ end }}
            {{ $suite | quote }}
            {{- end }}
          ]
        },
        "compression": {
          "enabled": {{ .Values.config.services.compression.enabled }},
          "type": {{ .Values.config.services.compression.type | quote }},
          "level": {{ .Values.config.services.compression.level }}
        },
        "handshake": {
          "timeout": {{ .Values.config.services.handshake.timeout | quote }},
          "contentType": {{ .Values.config.services.handshake.contentType | quote }}
        }
        {{- end }}
      },
      "enablePublishing": {{ .Values.config.enablePublishing }},
      "publisher": {
        "apiKey": {{ .Values.config.publisher.apiKey | default "" | quote }},
        "timeout": {{ .Values.config.publisher.timeout | quote }},
        "maxRetries": {{ .Values.config.publisher.maxRetries }},
        "retryDelay": {{ .Values.config.publisher.retryDelay | quote }},
        "enableCompression": {{ .Values.config.publisher.enableCompression }},
        "graph": {
          "url": {{ .Values.config.publisher.graph.url | default "" | quote }},
          "interval": {{ .Values.config.publisher.graph.interval | quote }}
        },
        "heartbeat": {
          "url": {{ .Values.config.publisher.heartbeat.url | default "" | quote }},
          "interval": {{ .Values.config.publisher.heartbeat.interval | quote }}
        }
      }
    }
